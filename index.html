<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Primary Meta Tags -->
    <title>Colored Noise | Free White, Pink & Brown Noise Generator for Sleep & Focus</title>
    <meta name="title" content="Colored Noise | Free White, Pink & Brown Noise Generator for Sleep & Focus">
    <meta name="description" content="Free online noise generator with 50+ presets. Generate white, pink, brown, blue, and violet noise for sleep, focus, meditation, and tinnitus relief. Features binaural beats, customizable fades, and sleep timer.">
    <meta name="keywords" content="white noise generator, pink noise, brown noise, sleep sounds, focus sounds, binaural beats, noise machine, tinnitus masking, meditation sounds, ambient noise, free noise generator, online sound machine">
    <meta name="author" content="Colored Noise">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href=""><!-- Add your URL here -->
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content=""><!-- Add your URL here -->
    <meta property="og:title" content="Colored Noise | Free Noise Generator for Sleep & Focus">
    <meta property="og:description" content="Free online noise generator with 50+ presets. White, pink, brown, blue & violet noise with binaural beats, sleep timer, and custom fades.">
    <meta property="og:image" content=""><!-- Add a preview image URL here (1200x630px recommended) -->
    <meta property="og:site_name" content="Colored Noise">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content=""><!-- Add your URL here -->
    <meta name="twitter:title" content="Colored Noise | Free Noise Generator for Sleep & Focus">
    <meta name="twitter:description" content="50+ noise presets: white, pink, brown, blue & violet. Binaural beats, sleep timer, custom fades. 100% free.">
    <meta name="twitter:image" content=""><!-- Add a preview image URL here -->
    
    <!-- Structured Data for Rich Results -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Colored Noise",
        "alternateName": "colorednoise.app",
        "description": "Free online noise generator with 50+ presets for sleep, focus, meditation, and tinnitus relief. Features white, pink, brown, blue, and violet noise with binaural beats and customizable settings.",
        "url": "",
        "applicationCategory": "HealthApplication",
        "operatingSystem": "Any",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "featureList": [
            "White noise generation",
            "Pink noise generation", 
            "Brown noise generation",
            "Blue noise generation",
            "Violet noise generation",
            "Binaural beats",
            "Sleep timer",
            "50+ sound presets",
            "Customizable fade in/out",
            "Save custom presets"
        ],
        "screenshot": "",
        "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": "4.8",
            "ratingCount": "1"
        }
    }
    </script>
    
    <!-- FAQ Structured Data for Rich Results -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        "mainEntity": [
            {
                "@type": "Question",
                "name": "What is the difference between white, pink, and brown noise?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "White noise contains equal energy across all frequencies, sounding like static. Pink noise has more bass and less treble (-3dB/octave), sounding like rainfall. Brown noise has even more bass (-6dB/octave), sounding like a deep rumble or waterfall. Blue and violet noise are the opposite, with more high-frequency content."
                }
            },
            {
                "@type": "Question", 
                "name": "What noise color is best for sleep?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Most people find pink or brown noise best for sleep. Pink noise mimics natural sounds like rain and has been shown in studies to improve deep sleep. Brown noise is even deeper and can feel more enveloping. Experiment with our sleep presets to find what works for you."
                }
            },
            {
                "@type": "Question",
                "name": "What are binaural beats?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Binaural beats occur when slightly different frequencies are played in each ear, and your brain perceives a third tone at the difference frequency. For example, 200Hz in one ear and 210Hz in the other creates a perceived 10Hz beat. Different frequencies are associated with different mental states: Delta (1-4Hz) for deep sleep, Theta (4-8Hz) for meditation, Alpha (8-12Hz) for relaxation, and Beta (12-40Hz) for focus."
                }
            },
            {
                "@type": "Question",
                "name": "Is this noise generator free?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Yes, this noise generator is completely free with no ads, no sign-up required, and no usage limits. All 50+ presets and features are available at no cost."
                }
            }
        ]
    }
    </script>
    
    <!-- Theme Color for Mobile Browsers -->
    <meta name="theme-color" content="#0a0a0f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><defs><linearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' stop-color='%238b5cf6'/><stop offset='25%25' stop-color='%233b82f6'/><stop offset='50%25' stop-color='%2300e5cc'/><stop offset='75%25' stop-color='%23f59e0b'/><stop offset='100%25' stop-color='%2392400e'/></linearGradient></defs><circle cx='16' cy='16' r='14' fill='url(%23g)'/><circle cx='16' cy='16' r='6' fill='%230a0a0f' opacity='0.8'/></svg>">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Space+Grotesk:wght@300;400;500;700&display=swap');
        
        :root {
            --bg: #0a0a0f;
            --panel: #12121a;
            --panel-elevated: #1a1a24;
            --accent: #00e5cc;
            --accent-secondary: #7b61ff;
            --accent-glow: rgba(0, 229, 204, 0.25);
            --accent-glow-strong: rgba(0, 229, 204, 0.5);
            --text: #e8e8ed;
            --text-dim: #6b6b7b;
            --border: #2a2a3a;
            --danger: #ff6b6b;
            --warning: #ffb86c;
        }
        
        * { box-sizing: border-box; }
        
        /* SEO content - visible to crawlers, hidden visually */
        .seo-header {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        body {
            font-family: 'Space Grotesk', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            background-image: 
                radial-gradient(ellipse at 20% 0%, rgba(0, 229, 204, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(123, 97, 255, 0.06) 0%, transparent 50%);
        }
        
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .container {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 20px;
            box-shadow: 
                0 25px 80px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.03) inset;
            overflow: hidden;
        }
        
        /* HEADER */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(180deg, rgba(255,255,255,0.02) 0%, transparent 100%);
        }
        
        .header-left h1 {
            margin: 0;
            font-weight: 500;
            font-size: 1.4rem;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, var(--text) 0%, var(--text-dim) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header-left .subtitle {
            margin: 2px 0 0 0;
            font-size: 0.75rem;
            color: var(--text-dim);
            font-weight: 400;
        }
        
        .header-left .status {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
            font-size: 0.75rem;
            margin-top: 4px;
            letter-spacing: 0.5px;
            min-height: 1.2em;
        }
        
        .header-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        #powerBtn {
            background: var(--panel-elevated);
            color: var(--text-dim);
            border: 1px solid var(--border);
            padding: 0.7rem 1.8rem;
            font-size: 0.9rem;
            font-weight: 500;
            font-family: inherit;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #powerBtn:hover {
            background: #252532;
            color: var(--text);
            border-color: #3a3a4a;
        }
        
        #powerBtn:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
        
        #powerBtn.playing {
            background: rgba(0, 229, 204, 0.1);
            color: var(--accent);
            border-color: var(--accent);
            box-shadow: 0 0 30px var(--accent-glow);
        }
        
        #powerBtn.fading {
            background: rgba(255, 184, 108, 0.1);
            color: var(--warning);
            border-color: var(--warning);
        }
        
        .kbd-hint {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            color: var(--text-dim);
            background: var(--bg);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid var(--border);
        }
        
        /* MAIN LAYOUT */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 360px;
            min-height: 520px;
        }
        
        /* LEFT PANEL - VISUALIZER & PRESETS */
        .left-panel {
            padding: 1.5rem 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            border-right: 1px solid var(--border);
        }
        
        /* VISUALIZER */
        .visualizer-container {
            background: var(--bg);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 1rem;
            position: relative;
            overflow: hidden;
        }
        
        .visualizer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .visualizer-header span {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
        }
        
        .viz-toggle {
            display: flex;
            gap: 4px;
        }
        
        .viz-toggle button {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 4px 10px;
            font-size: 0.7rem;
            font-family: 'JetBrains Mono', monospace;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .viz-toggle button:hover {
            border-color: var(--text-dim);
        }
        
        .viz-toggle button.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg);
        }
        
        #visualizer {
            width: 100%;
            height: 80px;
            display: block;
        }
        
        /* PRESETS */
        .presets-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .section-header h3 {
            margin: 0;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-dim);
            font-weight: 500;
        }
        
        .preset-filter {
            display: flex;
            gap: 4px;
        }
        
        .preset-filter button {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 3px 8px;
            font-size: 0.65rem;
            font-family: 'JetBrains Mono', monospace;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .preset-filter button:hover {
            border-color: var(--text-dim);
        }
        
        .preset-filter button.active {
            background: var(--accent-secondary);
            border-color: var(--accent-secondary);
            color: white;
        }
        
        .category-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px 16px;
            margin-bottom: 0.75rem;
            padding: 8px 0;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.65rem;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-dim);
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }
        
        .preset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(125px, 1fr));
            gap: 8px;
            overflow-y: auto;
            flex: 1;
            padding-right: 8px;
            align-content: start;
        }
        
        .preset-grid::-webkit-scrollbar {
            width: 4px;
        }
        
        .preset-grid::-webkit-scrollbar-track {
            background: var(--bg);
            border-radius: 2px;
        }
        
        .preset-grid::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 2px;
        }
        
        .preset-btn {
            background: var(--panel-elevated);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.75rem;
            font-family: inherit;
            text-align: left;
            transition: all 0.15s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .preset-btn:hover {
            background: #252532;
            border-color: #3a3a4a;
            transform: translateY(-1px);
        }
        
        .preset-btn:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
        
        .preset-btn.active {
            background: var(--accent);
            color: var(--bg);
            border-color: var(--accent);
            font-weight: 600;
        }
        
        .preset-btn .preset-name {
            font-weight: 500;
        }
        
        .preset-btn .preset-meta {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6rem;
            opacity: 0.6;
        }
        
        .preset-btn.active .preset-meta {
            opacity: 0.8;
        }
        
        .preset-btn.custom {
            border-style: dashed;
            border-color: var(--accent-secondary);
        }
        
        .preset-btn.custom.active {
            background: var(--accent-secondary);
            border-style: solid;
            color: white;
        }
        
        .delete-preset {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--danger);
            border: none;
            color: white;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            font-size: 10px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .preset-btn.custom:hover .delete-preset {
            opacity: 1;
        }
        
        /* Category colors */
        .preset-btn[data-category="sleep"] { border-left: 3px solid #8b5cf6; }
        .preset-btn[data-category="focus"] { border-left: 3px solid #3b82f6; }
        .preset-btn[data-category="ambient"] { border-left: 3px solid #10b981; }
        .preset-btn[data-category="nature"] { border-left: 3px solid #22c55e; }
        .preset-btn[data-category="mechanical"] { border-left: 3px solid #f59e0b; }
        .preset-btn[data-category="experimental"] { border-left: 3px solid #ef4444; }
        .preset-btn[data-category="textured"] { border-left: 3px solid #ec4899; }
        
        /* RIGHT PANEL */
        .right-panel {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background: rgba(0,0,0,0.2);
            overflow-y: auto;
        }
        
        .control-panel {
            background: var(--panel-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.25rem;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }
        
        .panel-header span {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
        }
        
        .reset-btn {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .reset-btn:hover {
            border-color: var(--text-dim);
            color: var(--text);
        }
        
        /* CONTROLS */
        .control-group {
            margin-bottom: 1rem;
        }
        
        .control-group:last-child {
            margin-bottom: 0;
        }
        
        .control-group label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 0.8rem;
            color: var(--text);
        }
        
        .control-group label span {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--accent);
        }
        
        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.6rem;
            color: var(--text-dim);
            margin-top: 3px;
            font-family: 'JetBrains Mono', monospace;
        }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--bg);
            border-radius: 3px;
            cursor: pointer;
            border: 1px solid var(--border);
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px var(--accent-glow);
            transition: transform 0.1s;
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px var(--accent-glow);
        }
        
        select {
            width: 100%;
            padding: 8px 10px;
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.8rem;
            cursor: pointer;
        }
        
        select:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        /* TOGGLE SWITCH */
        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 0;
        }
        
        .toggle-row span {
            font-size: 0.8rem;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 22px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider-toggle {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg);
            border: 1px solid var(--border);
            transition: 0.3s;
            border-radius: 22px;
        }
        
        .slider-toggle:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: var(--text-dim);
            transition: 0.3s;
            border-radius: 50%;
        }
        
        input:checked + .slider-toggle {
            background-color: var(--accent);
            border-color: var(--accent);
        }
        
        input:checked + .slider-toggle:before {
            transform: translateX(18px);
            background-color: var(--bg);
        }
        
        input:focus-visible + .slider-toggle {
            box-shadow: 0 0 0 2px var(--accent-glow);
        }
        
        /* FADE CONTROLS */
        .fade-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .fade-row .control-group {
            margin-bottom: 0;
        }
        
        /* Footer */
        .site-footer {
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 16px;
        }
        
        .site-footer > p {
            text-align: center;
            color: var(--text-dim);
            font-size: 0.8rem;
            margin: 0 0 1rem 0;
        }
        
        .faq-section {
            background: var(--panel-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .faq-section summary {
            padding: 12px 16px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text);
            list-style: none;
        }
        
        .faq-section summary::-webkit-details-marker {
            display: none;
        }
        
        .faq-section summary::before {
            content: "+ ";
            color: var(--accent);
            font-weight: bold;
            margin-right: 8px;
        }
        
        .faq-section[open] summary::before {
            content: "− ";
        }
        
        .faq-section p {
            padding: 0 16px 12px 28px;
            margin: 0;
            font-size: 0.8rem;
            color: var(--text-dim);
            line-height: 1.6;
        }
        
        .faq-section strong {
            color: var(--text);
        }
        
        /* TIMER */
        .timer-panel {
            background: var(--panel-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.25rem;
        }
        
        .timer-display {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.4rem;
            text-align: center;
            color: var(--text);
            margin: 0.5rem 0;
            letter-spacing: 2px;
        }
        
        .timer-display.active {
            color: var(--accent);
            text-shadow: 0 0 20px var(--accent-glow);
        }
        
        .timer-display.fading {
            color: var(--warning);
            text-shadow: 0 0 20px rgba(255, 184, 108, 0.4);
        }
        
        .timer-presets {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 0.5rem;
        }
        
        .timer-preset-btn {
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 5px 10px;
            font-size: 0.7rem;
            font-family: 'JetBrains Mono', monospace;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .timer-preset-btn:hover {
            border-color: var(--text-dim);
            color: var(--text);
        }
        
        .timer-preset-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg);
        }
        
        .timer-controls {
            display: flex;
            gap: 8px;
            justify-content: center;
        }
        
        .timer-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 5px 14px;
            font-size: 0.7rem;
            font-family: inherit;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .timer-btn:hover {
            border-color: var(--text-dim);
            color: var(--text);
        }
        
        .timer-btn.cancel {
            border-color: var(--danger);
            color: var(--danger);
        }
        
        /* SAVE PRESET */
        .save-preset-section {
            display: flex;
            gap: 8px;
        }
        
        .save-preset-section input {
            flex: 1;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 10px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.8rem;
        }
        
        .save-preset-section input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .save-preset-section input::placeholder {
            color: var(--text-dim);
        }
        
        .save-btn {
            background: var(--accent-secondary);
            border: none;
            color: white;
            padding: 8px 14px;
            font-size: 0.75rem;
            font-family: inherit;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }
        
        .save-btn:hover {
            filter: brightness(1.1);
        }
        
        /* KEYBOARD SHORTCUTS HINT */
        .shortcuts-hint {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6rem;
            color: var(--text-dim);
            text-align: center;
            padding: 0.75rem;
            border-top: 1px solid var(--border);
            background: rgba(0,0,0,0.2);
        }
        
        .shortcuts-hint kbd {
            background: var(--panel-elevated);
            padding: 2px 5px;
            border-radius: 3px;
            border: 1px solid var(--border);
            margin: 0 2px;
        }
        
        /* RESPONSIVE */
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .left-panel {
                border-right: none;
                border-bottom: 1px solid var(--border);
            }
            
            .preset-grid {
                max-height: 250px;
            }
        }
        
        @media (max-width: 500px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
                padding: 1rem;
            }
            
            .header-left h1 {
                font-size: 1.2rem;
            }
            
            .header-controls {
                width: 100%;
                justify-content: center;
            }
            
            .left-panel {
                padding: 1rem;
            }
            
            .right-panel {
                padding: 1rem;
            }
            
            #visualizer {
                height: 50px;
            }
            
            .preset-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .fade-row {
                grid-template-columns: 1fr;
            }
            
            .category-legend {
                justify-content: center;
            }
            
            .preset-filter {
                flex-wrap: wrap;
                justify-content: center;
                gap: 4px;
            }
            
            .section-header {
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>

<!-- Hidden SEO content - visible to search engines, visually hidden -->
<header class="seo-header" aria-hidden="true">
    <h1>Colored Noise - Free Online Noise Generator</h1>
    <p>Generate white noise, pink noise, brown noise, blue noise, and violet noise for free. Perfect for sleep, focus, studying, meditation, and tinnitus masking. Features 50+ presets, binaural beats, sleep timer, and customizable settings.</p>
</header>

<main>
<div class="app-container">
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>Colored Noise</h1>
                <p class="subtitle">A customizable noise generator for sleep and focus</p>
                <div class="status" id="statusDisplay">System Standby</div>
            </div>
            <div class="header-controls">
                <span class="kbd-hint">Space</span>
                <button id="powerBtn" aria-label="Power toggle">⏻ Power On</button>
            </div>
        </div>
        
        <div class="main-content">
            <div class="left-panel">
                <!-- Visualizer -->
                <div class="visualizer-container">
                    <div class="visualizer-header">
                        <span>Spectrum Analyzer</span>
                        <div class="viz-toggle">
                            <button id="vizBars" class="active" aria-label="Bar visualization">Bars</button>
                            <button id="vizWave" aria-label="Waveform visualization">Wave</button>
                        </div>
                    </div>
                    <canvas id="visualizer"></canvas>
                </div>
                
                <!-- Presets -->
                <div class="presets-section">
                    <div class="section-header">
                        <h3>Presets</h3>
                        <div class="preset-filter">
                            <button class="active" data-filter="all">All</button>
                            <button data-filter="sleep">Sleep</button>
                            <button data-filter="focus">Focus</button>
                            <button data-filter="nature">Nature</button>
                            <button data-filter="ambient">Ambient</button>
                            <button data-filter="mechanical">Mech</button>
                            <button data-filter="textured">Textured</button>
                        </div>
                    </div>
                    <div class="category-legend">
                        <span class="legend-item"><span class="legend-color" style="background:#8b5cf6"></span>Sleep</span>
                        <span class="legend-item"><span class="legend-color" style="background:#3b82f6"></span>Focus</span>
                        <span class="legend-item"><span class="legend-color" style="background:#22c55e"></span>Nature</span>
                        <span class="legend-item"><span class="legend-color" style="background:#10b981"></span>Ambient</span>
                        <span class="legend-item"><span class="legend-color" style="background:#f59e0b"></span>Mechanical</span>
                        <span class="legend-item"><span class="legend-color" style="background:#ef4444"></span>Experimental</span>
                        <span class="legend-item"><span class="legend-color" style="background:#ec4899"></span>Textured</span>
                    </div>
                    <div class="preset-grid" id="presetContainer" role="listbox" aria-label="Sound presets"></div>
                </div>
            </div>
            
            <div class="right-panel">
                <!-- Volume -->
                <div class="control-panel">
                    <div class="control-group">
                        <label>Master Volume <span id="valVol">50%</span></label>
                        <input type="range" id="sliderVol" min="0" max="1" step="0.01" value="0.5" aria-label="Master volume">
                    </div>
                </div>
                
                <!-- Sound Controls -->
                <div class="control-panel">
                    <div class="panel-header">
                        <span>Sound Settings</span>
                        <button class="reset-btn" id="resetBtn">Reset</button>
                    </div>
                    
                    <div class="control-group">
                        <label>Noise Color <span id="valColor">Pink</span></label>
                        <input type="range" id="sliderColor" min="0" max="4" step="0.01" value="3" aria-label="Noise color">
                        <div class="slider-labels">
                            <span>Violet</span>
                            <span>Blue</span>
                            <span>White</span>
                            <span>Pink</span>
                            <span>Brown</span>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label>Pulse Speed <span id="valPulse">Off</span></label>
                        <input type="range" id="sliderPulse" min="0" max="4" step="0.01" value="0" aria-label="Pulse speed">
                    </div>
                    
                    <div class="control-group">
                        <label>Pulse Shape</label>
                        <select id="selPulseShape" aria-label="Pulse waveform shape">
                            <option value="sine">Sine (Smooth)</option>
                            <option value="triangle">Triangle (Linear)</option>
                            <option value="square">Square (Choppy)</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label>Texture</label>
                        <select id="selDist" aria-label="Noise texture">
                            <option value="0">Natural (Gaussian)</option>
                            <option value="1">Smooth (Uniform)</option>
                        </select>
                    </div>
                    
                    <div class="toggle-row">
                        <span>Grey Noise (Perceptual EQ)</span>
                        <label class="switch">
                            <input type="checkbox" id="checkGrey" aria-label="Toggle grey noise equalization">
                            <span class="slider-toggle"></span>
                        </label>
                    </div>
                    
                    <div class="toggle-row">
                        <span>Binaural Mode</span>
                        <label class="switch">
                            <input type="checkbox" id="checkBinaural" aria-label="Toggle binaural beats">
                            <span class="slider-toggle"></span>
                        </label>
                    </div>
                    
                    <div class="control-group" id="binauralFreqGroup" style="display: none; margin-top: 0.75rem;">
                        <label>Binaural Frequency <span id="valBinaural">10 Hz</span></label>
                        <input type="range" id="sliderBinaural" min="1" max="40" step="0.5" value="10" aria-label="Binaural beat frequency">
                        <div class="slider-labels">
                            <span>Delta</span>
                            <span>Theta</span>
                            <span>Alpha</span>
                            <span>Beta</span>
                        </div>
                    </div>
                </div>
                
                <!-- Fade Controls -->
                <div class="control-panel">
                    <div class="panel-header">
                        <span>Fade Settings</span>
                    </div>
                    <div class="fade-row">
                        <div class="control-group">
                            <label>Fade In <span id="valFadeIn">1s</span></label>
                            <input type="range" id="sliderFadeIn" min="0" max="60" step="1" value="1" aria-label="Fade in duration">
                        </div>
                        <div class="control-group">
                            <label>Fade Out <span id="valFadeOut">2s</span></label>
                            <input type="range" id="sliderFadeOut" min="0" max="60" step="1" value="2" aria-label="Fade out duration">
                        </div>
                    </div>
                </div>
                
                <!-- Timer -->
                <div class="timer-panel">
                    <div class="panel-header">
                        <span>Sleep Timer</span>
                    </div>
                    <div class="timer-presets">
                        <button class="timer-preset-btn" data-mins="15">15m</button>
                        <button class="timer-preset-btn" data-mins="30">30m</button>
                        <button class="timer-preset-btn" data-mins="45">45m</button>
                        <button class="timer-preset-btn" data-mins="60">1h</button>
                        <button class="timer-preset-btn" data-mins="90">1.5h</button>
                        <button class="timer-preset-btn" data-mins="120">2h</button>
                    </div>
                    <div class="timer-display" id="timerDisplay">--:--</div>
                    <div class="timer-controls">
                        <button class="timer-btn cancel" id="timerCancel" style="display: none;">Cancel</button>
                    </div>
                </div>
                
                <!-- Save Preset -->
                <div class="control-panel">
                    <div class="panel-header">
                        <span>Save Custom Preset</span>
                    </div>
                    <div class="save-preset-section">
                        <input type="text" id="presetNameInput" placeholder="Preset name..." maxlength="20">
                        <button class="save-btn" id="savePresetBtn">Save</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="shortcuts-hint">
            <kbd>Space</kbd> Play/Pause &nbsp;
            <kbd>↑</kbd><kbd>↓</kbd> Volume &nbsp;
            <kbd>1</kbd>-<kbd>9</kbd> Presets
        </div>
    </div>
</main>

<footer class="site-footer">
    <p>Free noise generator for sleep, focus & relaxation. No ads, no signup.</p>
    <nav aria-label="Information">
        <details class="faq-section">
            <summary>What is white noise?</summary>
            <p>White noise contains equal energy at all frequencies, creating a consistent "shhhh" sound like TV static or a fan. It's effective for masking disruptive sounds and helping with sleep and concentration.</p>
        </details>
        <details class="faq-section">
            <summary>White vs Pink vs Brown noise - which is best?</summary>
            <p><strong>White noise</strong> has equal energy across frequencies - good for masking sharp sounds. <strong>Pink noise</strong> has more bass, sounds like rain, and studies suggest it may improve deep sleep. <strong>Brown noise</strong> is even deeper, like a waterfall or thunder, often preferred for relaxation. Try our presets to find your favorite!</p>
        </details>
        <details class="faq-section">
            <summary>How do binaural beats work?</summary>
            <p>Binaural beats play slightly different frequencies in each ear. Your brain perceives a third "beat" at the difference. Delta waves (1-4Hz) promote deep sleep, Theta (4-8Hz) aids meditation, Alpha (8-12Hz) encourages relaxation, and Beta (12-40Hz) supports focus and alertness.</p>
        </details>
    </nav>
</footer>

</div>

<script>
// --- 1. AudioWorklet Processor ---
const workletCode = `
class NoiseProcessor extends AudioWorkletProcessor {
    constructor() {
        super();
        // Pink noise state (per channel)
        this.b0 = [0, 0]; this.b1 = [0, 0]; this.b2 = [0, 0];
        this.b3 = [0, 0]; this.b4 = [0, 0]; this.b5 = [0, 0]; this.b6 = [0, 0];
        // Brown noise state
        this.brownState = [0, 0];
        // Blue/Violet state (high-pass filtering)
        this.lastWhite = [0, 0];
        this.lastBlue = [0, 0];
    }
    
    static get parameterDescriptors() {
        return [
            { name: 'color', defaultValue: 3, minValue: 0, maxValue: 4 },
            { name: 'texture', defaultValue: 0, minValue: 0, maxValue: 1 }
        ];
    }
    
    process(inputs, outputs, parameters) {
        const output = outputs[0];
        const colorParam = parameters['color'];
        const texParam = parameters['texture'];
        
        for (let ch = 0; ch < output.length; ch++) {
            const outData = output[ch];
            const isColorConst = colorParam.length === 1;
            const isTexConst = texParam.length === 1;
            
            for (let i = 0; i < outData.length; i++) {
                const alpha = isColorConst ? colorParam[0] : colorParam[i];
                const texture = isTexConst ? texParam[0] : texParam[i];
                
                // Generate white noise base
                let white = 0;
                if (texture < 0.5) {
                    // Gaussian approximation via Central Limit Theorem
                    const u = Math.random() + Math.random() + Math.random() + Math.random();
                    white = (u - 2.0) * 0.75;
                } else {
                    // Uniform distribution
                    white = Math.random() * 2 - 1;
                }
                
                // === VIOLET NOISE (+6dB/octave) ===
                const violet = (white - this.lastWhite[ch]) * 0.5;
                this.lastWhite[ch] = white;
                
                // === BLUE NOISE (+3dB/octave) ===
                const blue = (violet + this.lastBlue[ch]) * 0.5;
                this.lastBlue[ch] = blue;
                
                // === PINK NOISE (-3dB/octave, Paul Kellett algorithm) ===
                this.b0[ch] = 0.99886 * this.b0[ch] + white * 0.0555179;
                this.b1[ch] = 0.99332 * this.b1[ch] + white * 0.0750759;
                this.b2[ch] = 0.96900 * this.b2[ch] + white * 0.1538520;
                this.b3[ch] = 0.86650 * this.b3[ch] + white * 0.3104856;
                this.b4[ch] = 0.55000 * this.b4[ch] + white * 0.5329522;
                this.b5[ch] = -0.7616 * this.b5[ch] - white * 0.0168981;
                const pink = (this.b0[ch] + this.b1[ch] + this.b2[ch] + this.b3[ch] + 
                             this.b4[ch] + this.b5[ch] + this.b6[ch] + white * 0.5362) * 0.11;
                this.b6[ch] = white * 0.115926;
                
                // === BROWN NOISE (-6dB/octave) ===
                let brown = (this.brownState[ch] + (0.02 * white)) / 1.02;
                this.brownState[ch] = brown;
                brown = Math.max(-1, Math.min(1, brown * 3.5));
                
                // === MIX based on alpha (0-4 scale) ===
                // 0=Violet, 1=Blue, 2=White, 3=Pink, 4=Brown
                let s = 0;
                if (alpha <= 1) {
                    s = (1 - alpha) * violet + alpha * blue;
                } else if (alpha <= 2) {
                    const t = alpha - 1;
                    s = (1 - t) * blue + t * white;
                } else if (alpha <= 3) {
                    const t = alpha - 2;
                    s = (1 - t) * white + t * pink;
                } else {
                    const t = alpha - 3;
                    s = (1 - t) * pink + t * brown;
                }
                
                outData[i] = s;
            }
        }
        return true;
    }
}
registerProcessor('noise-processor', NoiseProcessor);
`;

// --- 2. Preset Data (45 presets organized by category) ---
const builtInPresets = [
    // === SLEEP (9 presets) ===
    { name: "Deep Sleep", category: "sleep", alpha: 3.95, pulse: 0.12, pulseShape: "sine", grey: false, dist: 0, binaural: true, binauralFreq: 2.5, fadeIn: 30, fadeOut: 45 },
    { name: "Womb Sound", category: "sleep", alpha: 4, pulse: 0.08, pulseShape: "sine", grey: true, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 20, fadeOut: 30 },
    { name: "Lucid Dream", category: "sleep", alpha: 3.8, pulse: 0, pulseShape: "sine", grey: false, dist: 0, binaural: true, binauralFreq: 5, fadeIn: 25, fadeOut: 40 },
    { name: "Night Cocoon", category: "sleep", alpha: 3.9, pulse: 0.05, pulseShape: "triangle", grey: true, dist: 0, binaural: true, binauralFreq: 3, fadeIn: 30, fadeOut: 60 },
    { name: "Drift Away", category: "sleep", alpha: 3.7, pulse: 0.1, pulseShape: "sine", grey: false, dist: 0, binaural: true, binauralFreq: 4, fadeIn: 20, fadeOut: 30 },
    { name: "Heavy Blanket", category: "sleep", alpha: 4, pulse: 0, pulseShape: "sine", grey: true, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 15, fadeOut: 25 },
    { name: "Midnight Hum", category: "sleep", alpha: 3.85, pulse: 0.06, pulseShape: "sine", grey: true, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 20, fadeOut: 30 },
    { name: "Delta Waves", category: "sleep", alpha: 3.6, pulse: 0, pulseShape: "sine", grey: false, dist: 0, binaural: true, binauralFreq: 2, fadeIn: 30, fadeOut: 45 },
    { name: "Slow Descent", category: "sleep", alpha: 3.75, pulse: 0.04, pulseShape: "triangle", grey: false, dist: 0, binaural: true, binauralFreq: 3.5, fadeIn: 45, fadeOut: 60 },
    
    // === FOCUS (8 presets) ===
    { name: "Focus Zone", category: "focus", alpha: 3.5, pulse: 0, pulseShape: "sine", grey: true, dist: 0, binaural: true, binauralFreq: 14, fadeIn: 3, fadeOut: 5 },
    { name: "Study Hall", category: "focus", alpha: 1.2, pulse: 0, pulseShape: "sine", grey: false, dist: 0, binaural: true, binauralFreq: 18, fadeIn: 2, fadeOut: 3 },
    { name: "Alpha Waves", category: "focus", alpha: 3, pulse: 0, pulseShape: "sine", grey: false, dist: 0, binaural: true, binauralFreq: 10, fadeIn: 5, fadeOut: 8 },
    { name: "Deep Work", category: "focus", alpha: 3.4, pulse: 0, pulseShape: "sine", grey: true, dist: 0, binaural: true, binauralFreq: 16, fadeIn: 3, fadeOut: 5 },
    { name: "Concentration", category: "focus", alpha: 2.8, pulse: 0, pulseShape: "sine", grey: true, dist: 1, binaural: true, binauralFreq: 12, fadeIn: 2, fadeOut: 4 },
    { name: "Beta Boost", category: "focus", alpha: 2.5, pulse: 0, pulseShape: "sine", grey: false, dist: 0, binaural: true, binauralFreq: 20, fadeIn: 1, fadeOut: 2 },
    { name: "Flow State", category: "focus", alpha: 3.2, pulse: 0, pulseShape: "sine", grey: false, dist: 0, binaural: true, binauralFreq: 11, fadeIn: 5, fadeOut: 8 },
    { name: "Theta Meditation", category: "focus", alpha: 3.5, pulse: 0, pulseShape: "sine", grey: true, dist: 0, binaural: true, binauralFreq: 6, fadeIn: 10, fadeOut: 15 },
    
    // === NATURE (9 presets) ===
    { name: "Ocean Waves", category: "nature", alpha: 3.2, pulse: 0.18, pulseShape: "sine", grey: false, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 5, fadeOut: 10 },
    { name: "Heavy Rain", category: "nature", alpha: 3.3, pulse: 0, pulseShape: "sine", grey: false, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 3, fadeOut: 8 },
    { name: "Distant Thunder", category: "nature", alpha: 4, pulse: 0.08, pulseShape: "triangle", grey: true, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 8, fadeOut: 15 },
    { name: "Waterfall", category: "nature", alpha: 2.8, pulse: 0, pulseShape: "sine", grey: false, dist: 1, binaural: false, binauralFreq: 10, fadeIn: 3, fadeOut: 5 },
    { name: "Windy Day", category: "nature", alpha: 3.1, pulse: 0.35, pulseShape: "triangle", grey: false, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 4, fadeOut: 8 },
    { name: "Mountain Wind", category: "nature", alpha: 1.8, pulse: 0.5, pulseShape: "triangle", grey: false, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 5, fadeOut: 10 },
    { name: "Rain on Tent", category: "nature", alpha: 3.4, pulse: 0.15, pulseShape: "sine", grey: false, dist: 1, binaural: false, binauralFreq: 10, fadeIn: 4, fadeOut: 8 },
    { name: "Night Forest", category: "nature", alpha: 3.65, pulse: 0.07, pulseShape: "triangle", grey: false, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 8, fadeOut: 15 },
    { name: "Seaside Cave", category: "nature", alpha: 3.8, pulse: 0.12, pulseShape: "sine", grey: true, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 6, fadeOut: 12 },
    
    // === AMBIENT (9 presets) ===
    { name: "Pure White", category: "ambient", alpha: 2, pulse: 0, pulseShape: "sine", grey: false, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 1, fadeOut: 2 },
    { name: "Standard Pink", category: "ambient", alpha: 3, pulse: 0, pulseShape: "sine", grey: false, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 1, fadeOut: 2 },
    { name: "Deep Brown", category: "ambient", alpha: 4, pulse: 0, pulseShape: "sine", grey: false, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 2, fadeOut: 4 },
    { name: "Blue Sky", category: "ambient", alpha: 1, pulse: 0, pulseShape: "sine", grey: false, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 1, fadeOut: 2 },
    { name: "Violet Haze", category: "ambient", alpha: 0.2, pulse: 0, pulseShape: "sine", grey: false, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 2, fadeOut: 3 },
    { name: "Grey Noise", category: "ambient", alpha: 2, pulse: 0, pulseShape: "sine", grey: true, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 1, fadeOut: 2 },
    { name: "Soft Air", category: "ambient", alpha: 3.4, pulse: 0, pulseShape: "sine", grey: false, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 2, fadeOut: 4 },
    { name: "Coffee Shop", category: "ambient", alpha: 2.6, pulse: 0, pulseShape: "sine", grey: false, dist: 1, binaural: false, binauralFreq: 10, fadeIn: 2, fadeOut: 3 },
    { name: "Tinnitus Mask", category: "ambient", alpha: 1.5, pulse: 0, pulseShape: "sine", grey: true, dist: 1, binaural: false, binauralFreq: 10, fadeIn: 5, fadeOut: 10 },
    
    // === MECHANICAL (10 presets) ===
    { name: "Airplane Cabin", category: "mechanical", alpha: 3.5, pulse: 0, pulseShape: "sine", grey: true, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 3, fadeOut: 5 },
    { name: "Box Fan", category: "mechanical", alpha: 3.3, pulse: 0, pulseShape: "sine", grey: true, dist: 1, binaural: false, binauralFreq: 10, fadeIn: 1, fadeOut: 2 },
    { name: "Space Station", category: "mechanical", alpha: 3.9, pulse: 0.04, pulseShape: "sine", grey: true, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 5, fadeOut: 10 },
    { name: "Server Room", category: "mechanical", alpha: 1.6, pulse: 0, pulseShape: "sine", grey: true, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 2, fadeOut: 3 },
    { name: "Diesel Engine", category: "mechanical", alpha: 4, pulse: 1.4, pulseShape: "triangle", grey: false, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 3, fadeOut: 5 },
    { name: "CPU Fan", category: "mechanical", alpha: 1.3, pulse: 0, pulseShape: "sine", grey: true, dist: 1, binaural: false, binauralFreq: 10, fadeIn: 1, fadeOut: 2 },
    { name: "Furnace", category: "mechanical", alpha: 3.7, pulse: 0.7, pulseShape: "triangle", grey: false, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 4, fadeOut: 8 },
    { name: "Submarine", category: "mechanical", alpha: 3.95, pulse: 0.06, pulseShape: "sine", grey: true, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 8, fadeOut: 15 },
    { name: "Electric Hum", category: "mechanical", alpha: 3.2, pulse: 0.5, pulseShape: "square", grey: false, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 1, fadeOut: 2 },
    { name: "Jet Stream", category: "mechanical", alpha: 0.8, pulse: 0, pulseShape: "sine", grey: true, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 3, fadeOut: 5 },
    
    // === EXPERIMENTAL (5 presets) ===
    { name: "Static TV", category: "experimental", alpha: 2, pulse: 2.5, pulseShape: "square", grey: false, dist: 1, binaural: false, binauralFreq: 10, fadeIn: 0, fadeOut: 1 },
    { name: "Vinyl Crackle", category: "experimental", alpha: 0.4, pulse: 0.3, pulseShape: "triangle", grey: false, dist: 1, binaural: false, binauralFreq: 10, fadeIn: 2, fadeOut: 3 },
    { name: "Cicadas", category: "experimental", alpha: 1.1, pulse: 3.2, pulseShape: "sine", grey: false, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 3, fadeOut: 5 },
    { name: "ASMR Static", category: "experimental", alpha: 0.3, pulse: 0, pulseShape: "sine", grey: true, dist: 1, binaural: false, binauralFreq: 10, fadeIn: 5, fadeOut: 8 },
    { name: "Breath Work", category: "experimental", alpha: 3.2, pulse: 0.1, pulseShape: "sine", grey: false, dist: 0, binaural: true, binauralFreq: 10, fadeIn: 10, fadeOut: 15 },
    
    // === TEXTURED (8 presets) - Using resonant filters and comb filters ===
    { name: "Resonant Drone", category: "textured", alpha: 3.5, pulse: 0, pulseShape: "sine", grey: false, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 8, fadeOut: 12,
      resonant: { enabled: true, frequencies: [110, 220, 330], q: 25, mix: 0.6 } },
    { name: "Singing Pipes", category: "textured", alpha: 2.5, pulse: 0.08, pulseShape: "sine", grey: false, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 5, fadeOut: 10,
      resonant: { enabled: true, frequencies: [180, 360, 540], q: 30, mix: 0.5 } },
    { name: "Tibetan Bowl", category: "textured", alpha: 3.2, pulse: 0, pulseShape: "sine", grey: false, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 10, fadeOut: 20,
      resonant: { enabled: true, frequencies: [256, 384, 512], q: 40, mix: 0.4 } },
    { name: "Metal Wind", category: "textured", alpha: 2, pulse: 0.15, pulseShape: "triangle", grey: false, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 4, fadeOut: 8,
      comb: { enabled: true, delay: 0.003, feedback: 0.75, mix: 0.4 } },
    { name: "Hollow Tube", category: "textured", alpha: 3, pulse: 0, pulseShape: "sine", grey: false, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 3, fadeOut: 6,
      comb: { enabled: true, delay: 0.008, feedback: 0.8, mix: 0.5 } },
    { name: "Spaceship Hull", category: "textured", alpha: 3.8, pulse: 0.03, pulseShape: "sine", grey: true, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 10, fadeOut: 15,
      comb: { enabled: true, delay: 0.015, feedback: 0.7, mix: 0.35 },
      resonant: { enabled: true, frequencies: [80, 160, 240], q: 15, mix: 0.3 } },
    { name: "Wind Chimes", category: "textured", alpha: 1.5, pulse: 0.2, pulseShape: "triangle", grey: false, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 3, fadeOut: 5,
      resonant: { enabled: true, frequencies: [523, 659, 784], q: 35, mix: 0.5 } },
    { name: "Cave Ambience", category: "textured", alpha: 4, pulse: 0.05, pulseShape: "sine", grey: true, dist: 0, binaural: false, binauralFreq: 10, fadeIn: 15, fadeOut: 25,
      comb: { enabled: true, delay: 0.025, feedback: 0.6, mix: 0.4 },
      resonant: { enabled: true, frequencies: [100, 150, 200], q: 12, mix: 0.25 } }
];

// Load/save custom presets
function loadCustomPresets() {
    try {
        const saved = localStorage.getItem('stochastic-custom-presets-v2');
        return saved ? JSON.parse(saved) : [];
    } catch (e) { return []; }
}

function saveCustomPresets(presets) {
    try {
        localStorage.setItem('stochastic-custom-presets-v2', JSON.stringify(presets));
    } catch (e) { console.warn('Could not save presets'); }
}

let customPresets = loadCustomPresets();

// Current settings state
let currentSettings = {
    alpha: 3,
    pulse: 0,
    pulseShape: "sine",
    grey: false,
    dist: 0,
    binaural: false,
    binauralFreq: 10,
    fadeIn: 1,
    fadeOut: 2
};

let currentPresetName = "Standard Pink";
let activePresetBtn = null;
let currentFilter = 'all';

// --- 3. DOM Elements ---
const presetContainer = document.getElementById('presetContainer');
const powerBtn = document.getElementById('powerBtn');
const statusDisplay = document.getElementById('statusDisplay');

const sliderColor = document.getElementById('sliderColor');
const sliderPulse = document.getElementById('sliderPulse');
const sliderVol = document.getElementById('sliderVol');
const sliderBinaural = document.getElementById('sliderBinaural');
const sliderFadeIn = document.getElementById('sliderFadeIn');
const sliderFadeOut = document.getElementById('sliderFadeOut');
const selDist = document.getElementById('selDist');
const selPulseShape = document.getElementById('selPulseShape');
const checkGrey = document.getElementById('checkGrey');
const checkBinaural = document.getElementById('checkBinaural');
const binauralFreqGroup = document.getElementById('binauralFreqGroup');

const valColor = document.getElementById('valColor');
const valPulse = document.getElementById('valPulse');
const valVol = document.getElementById('valVol');
const valBinaural = document.getElementById('valBinaural');
const valFadeIn = document.getElementById('valFadeIn');
const valFadeOut = document.getElementById('valFadeOut');

const timerDisplay = document.getElementById('timerDisplay');
const timerCancel = document.getElementById('timerCancel');
const presetNameInput = document.getElementById('presetNameInput');
const savePresetBtn = document.getElementById('savePresetBtn');
const resetBtn = document.getElementById('resetBtn');

const vizBarsBtn = document.getElementById('vizBars');
const vizWaveBtn = document.getElementById('vizWave');
const canvas = document.getElementById('visualizer');
const ctx = canvas.getContext('2d');

// Audio nodes
let audioCtx = null;
let noiseNode = null;
let gainNode = null;
let pulseOsc = null;
let pulseGain = null;
let analyser = null;
let greyLow = null;
let greyHigh = null;
let depthNode = null;

// Texture filters
let resonantFilters = [];
let resonantGains = [];
let combDelay = null;
let combFeedback = null;
let combMix = null;
let dryGain = null;
let wetMix = null;

let isPlaying = false;
let isFading = false;
let fadeTimer = null;
let rampTimer = null;
let blobUrl = null;

// Timer state
let timerInterval = null;
let timerEndTime = null;
let timerFadeStarted = false;

// Visualizer state
let vizMode = 'bars';
let animationId = null;

// --- 4. Initialize Presets UI ---
function renderPresets() {
    presetContainer.innerHTML = '';
    
    const presetsToShow = currentFilter === 'all' 
        ? builtInPresets 
        : builtInPresets.filter(p => p.category === currentFilter);
    
    presetsToShow.forEach((p, idx) => {
        const btn = document.createElement('button');
        btn.className = 'preset-btn';
        btn.setAttribute('data-category', p.category);
        btn.setAttribute('role', 'option');
        btn.setAttribute('aria-selected', 'false');
        
        const fadeInfo = `${p.fadeIn}s/${p.fadeOut}s`;
        btn.innerHTML = `<span class="preset-name">${p.name}</span><span class="preset-meta">${fadeInfo}</span>`;
        
        btn.onclick = () => activatePreset(p, btn);
        
        if (currentFilter === 'all' && idx < 9) {
            btn.title = `Press ${idx + 1} to activate`;
        }
        
        presetContainer.appendChild(btn);
    });
    
    // Custom presets
    customPresets.forEach((p, idx) => {
        const btn = document.createElement('button');
        btn.className = 'preset-btn custom';
        btn.setAttribute('role', 'option');
        btn.setAttribute('aria-selected', 'false');
        
        const fadeInfo = `${p.fadeIn || 1}s/${p.fadeOut || 2}s`;
        btn.innerHTML = `
            <span class="preset-name">${p.name}</span>
            <span class="preset-meta">${fadeInfo}</span>
            <button class="delete-preset" aria-label="Delete preset">×</button>
        `;
        
        btn.onclick = (e) => {
            if (e.target.classList.contains('delete-preset')) {
                deleteCustomPreset(idx);
            } else {
                activatePreset(p, btn);
            }
        };
        
        presetContainer.appendChild(btn);
    });
}

function deleteCustomPreset(idx) {
    customPresets.splice(idx, 1);
    saveCustomPresets(customPresets);
    renderPresets();
}

// Filter buttons
document.querySelectorAll('.preset-filter button').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.preset-filter button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        renderPresets();
    });
});

// --- 5. Labels Update ---
function updateLabels() {
    const c = parseFloat(sliderColor.value);
    if (c < 0.5) valColor.textContent = "Violet";
    else if (c < 1.5) valColor.textContent = "Blue";
    else if (c < 2.5) valColor.textContent = "White";
    else if (c < 3.5) valColor.textContent = "Pink";
    else valColor.textContent = "Brown";
    
    const p = parseFloat(sliderPulse.value);
    valPulse.textContent = p === 0 ? "Off" : p.toFixed(2) + " Hz";
    
    valVol.textContent = Math.round(sliderVol.value * 100) + "%";
    valBinaural.textContent = sliderBinaural.value + " Hz";
    
    const fi = parseInt(sliderFadeIn.value);
    valFadeIn.textContent = fi === 0 ? "Instant" : fi + "s";
    
    const fo = parseInt(sliderFadeOut.value);
    valFadeOut.textContent = fo === 0 ? "Instant" : fo + "s";
}

// --- 6. Settings Application ---
function applySettings(s, instant = false) {
    if (!noiseNode) return;
    
    const now = audioCtx.currentTime;
    const timeConstant = instant ? 0 : 0.15;
    
    // Color
    const colorParam = noiseNode.parameters.get('color');
    if (instant) {
        colorParam.setValueAtTime(parseFloat(s.alpha), now);
    } else {
        colorParam.setTargetAtTime(parseFloat(s.alpha), now, timeConstant);
    }
    
    // Texture
    const texParam = noiseNode.parameters.get('texture');
    texParam.setValueAtTime(parseFloat(s.dist), now);
    
    // Pulse
    const pVal = parseFloat(s.pulse);
    if (pVal > 0) {
        pulseOsc.type = s.pulseShape || 'sine';
        pulseOsc.frequency.setValueAtTime(pVal, now);
        depthNode.gain.setTargetAtTime(0.3, now, timeConstant);
        pulseGain.gain.setTargetAtTime(0.7, now, timeConstant);
    } else {
        depthNode.gain.setTargetAtTime(0, now, timeConstant);
        pulseGain.gain.setTargetAtTime(1, now, timeConstant);
    }
    
    // Grey noise EQ
    const gGain = s.grey ? 10 : 0;
    if (instant) {
        greyLow.gain.cancelScheduledValues(now);
        greyHigh.gain.cancelScheduledValues(now);
        greyLow.gain.setValueAtTime(gGain, now);
        greyHigh.gain.setValueAtTime(gGain / 2, now);
    } else {
        greyLow.gain.setTargetAtTime(gGain, now, timeConstant);
        greyHigh.gain.setTargetAtTime(gGain / 2, now, timeConstant);
    }
    
    // === RESONANT FILTERS ===
    // resonant: { enabled: bool, frequencies: [f1, f2, f3], q: number, mix: number }
    if (s.resonant && s.resonant.enabled) {
        const r = s.resonant;
        for (let i = 0; i < 3; i++) {
            const freq = r.frequencies[i] || (200 * (i + 1));
            const q = r.q || 10;
            const mix = r.mix || 0.5;
            
            if (instant) {
                resonantFilters[i].frequency.setValueAtTime(freq, now);
                resonantFilters[i].Q.setValueAtTime(q, now);
                resonantGains[i].gain.setValueAtTime(mix / 3, now);
            } else {
                resonantFilters[i].frequency.setTargetAtTime(freq, now, timeConstant);
                resonantFilters[i].Q.setTargetAtTime(q, now, timeConstant);
                resonantGains[i].gain.setTargetAtTime(mix / 3, now, timeConstant);
            }
        }
        // Reduce dry signal when resonant is active
        dryGain.gain.setTargetAtTime(1 - (r.mix * 0.5), now, timeConstant);
    } else {
        // Turn off resonant filters
        for (let i = 0; i < 3; i++) {
            resonantGains[i].gain.setTargetAtTime(0, now, timeConstant);
        }
        dryGain.gain.setTargetAtTime(1, now, timeConstant);
    }
    
    // === COMB FILTER ===
    // comb: { enabled: bool, delay: number (seconds), feedback: number, mix: number }
    if (s.comb && s.comb.enabled) {
        const c = s.comb;
        const delayTime = c.delay || 0.005;
        const feedback = c.feedback || 0.7;
        const mix = c.mix || 0.3;
        
        if (instant) {
            combDelay.delayTime.setValueAtTime(delayTime, now);
            combFeedback.gain.setValueAtTime(feedback, now);
            combMix.gain.setValueAtTime(mix, now);
        } else {
            combDelay.delayTime.setTargetAtTime(delayTime, now, timeConstant);
            combFeedback.gain.setTargetAtTime(feedback, now, timeConstant);
            combMix.gain.setTargetAtTime(mix, now, timeConstant);
        }
    } else {
        // Turn off comb filter
        combFeedback.gain.setTargetAtTime(0, now, timeConstant);
        combMix.gain.setTargetAtTime(0, now, timeConstant);
    }
}

// --- 7. Preset Activation ---
function activatePreset(p, btnElem) {
    currentSettings = { ...p };
    currentPresetName = p.name;
    
    // Update UI
    document.querySelectorAll('.preset-btn').forEach(b => {
        b.classList.remove('active');
        b.setAttribute('aria-selected', 'false');
    });
    btnElem.classList.add('active');
    btnElem.setAttribute('aria-selected', 'true');
    activePresetBtn = btnElem;
    
    // Sync controls
    sliderColor.value = p.alpha;
    sliderPulse.value = p.pulse;
    selPulseShape.value = p.pulseShape || 'sine';
    selDist.value = p.dist;
    checkGrey.checked = p.grey;
    checkBinaural.checked = p.binaural || false;
    sliderBinaural.value = p.binauralFreq || 10;
    sliderFadeIn.value = p.fadeIn || 1;
    sliderFadeOut.value = p.fadeOut || 2;
    binauralFreqGroup.style.display = p.binaural ? 'block' : 'none';
    
    updateLabels();
    applySettings(p, true);
    updateURL();
    
    statusDisplay.textContent = "Playing: " + p.name;
    if (!isPlaying) powerOn();
}

// --- 8. Control Listeners ---
function syncFromControls() {
    currentSettings = {
        alpha: parseFloat(sliderColor.value),
        pulse: parseFloat(sliderPulse.value),
        pulseShape: selPulseShape.value,
        grey: checkGrey.checked,
        dist: parseInt(selDist.value),
        binaural: checkBinaural.checked,
        binauralFreq: parseFloat(sliderBinaural.value),
        fadeIn: parseInt(sliderFadeIn.value),
        fadeOut: parseInt(sliderFadeOut.value)
    };
    
    if (activePresetBtn) {
        activePresetBtn.classList.remove('active');
        activePresetBtn.setAttribute('aria-selected', 'false');
        activePresetBtn = null;
    }
    currentPresetName = "Custom";
    
    updateLabels();
    applySettings(currentSettings, false);
    updateURL();
    
    if (isPlaying) {
        statusDisplay.textContent = "Playing: Custom";
    }
}

[sliderColor, sliderPulse, selPulseShape, selDist, checkGrey, sliderFadeIn, sliderFadeOut].forEach(el => {
    el.addEventListener('input', syncFromControls);
});

checkBinaural.addEventListener('change', () => {
    binauralFreqGroup.style.display = checkBinaural.checked ? 'block' : 'none';
    syncFromControls();
});

sliderBinaural.addEventListener('input', () => {
    updateLabels();
    syncFromControls();
});

sliderVol.addEventListener('input', () => {
    updateLabels();
    if (gainNode && isPlaying && !isFading) {
        gainNode.gain.setTargetAtTime(parseFloat(sliderVol.value), audioCtx.currentTime, 0.1);
    }
});

resetBtn.addEventListener('click', () => {
    sliderColor.value = 3;
    sliderPulse.value = 0;
    selPulseShape.value = 'sine';
    selDist.value = 0;
    checkGrey.checked = false;
    checkBinaural.checked = false;
    sliderBinaural.value = 10;
    sliderFadeIn.value = 1;
    sliderFadeOut.value = 2;
    binauralFreqGroup.style.display = 'none';
    syncFromControls();
});

// --- 9. Save Custom Preset ---
savePresetBtn.addEventListener('click', () => {
    const name = presetNameInput.value.trim();
    if (!name) {
        presetNameInput.focus();
        return;
    }
    
    const newPreset = {
        name,
        category: "custom",
        ...currentSettings
    };
    
    customPresets.push(newPreset);
    saveCustomPresets(customPresets);
    renderPresets();
    presetNameInput.value = '';
});

presetNameInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') savePresetBtn.click();
});

// --- 10. Power Control with Fade ---
async function powerOn() {
    if (!audioCtx) await initAudio();
    if (audioCtx.state === 'suspended') await audioCtx.resume();
    
    // Cancel any pending operations
    if (rampTimer) clearTimeout(rampTimer);
    if (fadeTimer) clearTimeout(fadeTimer);
    isFading = false;
    
    const fadeInTime = currentSettings.fadeIn || 1;
    const targetVol = parseFloat(sliderVol.value);
    
    gainNode.gain.cancelScheduledValues(audioCtx.currentTime);
    gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
    gainNode.gain.linearRampToValueAtTime(targetVol, audioCtx.currentTime + fadeInTime);
    
    powerBtn.innerHTML = "⏻ Power Off";
    powerBtn.classList.add('playing');
    powerBtn.classList.remove('fading');
    
    if (fadeInTime > 0) {
        statusDisplay.textContent = `Fading in: ${currentPresetName} (${fadeInTime}s)`;
        isFading = true;
        powerBtn.classList.add('fading');
        
        fadeTimer = setTimeout(() => {
            isFading = false;
            powerBtn.classList.remove('fading');
            statusDisplay.textContent = "Playing: " + currentPresetName;
        }, fadeInTime * 1000);
    } else {
        statusDisplay.textContent = "Playing: " + currentPresetName;
    }
    
    isPlaying = true;
    startVisualizer();
}

function powerOff(immediate = false) {
    if (!audioCtx) return;
    
    if (fadeTimer) clearTimeout(fadeTimer);
    
    const fadeOutTime = immediate ? 0.1 : (currentSettings.fadeOut || 2);
    
    gainNode.gain.cancelScheduledValues(audioCtx.currentTime);
    gainNode.gain.setValueAtTime(gainNode.gain.value, audioCtx.currentTime);
    gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + fadeOutTime);
    
    powerBtn.innerHTML = "⏻ Power On";
    powerBtn.classList.remove('playing');
    
    if (fadeOutTime > 0.5) {
        isFading = true;
        powerBtn.classList.add('fading');
        statusDisplay.textContent = `Fading out (${fadeOutTime}s)...`;
    } else {
        statusDisplay.textContent = "System Standby";
    }
    
    isPlaying = false;
    
    rampTimer = setTimeout(() => {
        isFading = false;
        powerBtn.classList.remove('fading');
        statusDisplay.textContent = "System Standby";
        stopVisualizer();
        if (!isPlaying && audioCtx) {
            audioCtx.suspend();
        }
    }, fadeOutTime * 1000 + 100);
}

powerBtn.onclick = () => {
    if (isPlaying) powerOff();
    else powerOn();
};

// --- 11. Audio Initialization ---
async function initAudio() {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    const blob = new Blob([workletCode], { type: 'application/javascript' });
    blobUrl = URL.createObjectURL(blob);
    await audioCtx.audioWorklet.addModule(blobUrl);
    URL.revokeObjectURL(blobUrl);
    blobUrl = null;
    
    noiseNode = new AudioWorkletNode(audioCtx, 'noise-processor', {
        numberOfInputs: 0,
        numberOfOutputs: 1,
        outputChannelCount: [2]
    });
    
    greyLow = audioCtx.createBiquadFilter();
    greyLow.type = "lowshelf";
    greyLow.frequency.value = 100;
    greyLow.gain.value = 0;
    
    greyHigh = audioCtx.createBiquadFilter();
    greyHigh.type = "highshelf";
    greyHigh.frequency.value = 6000;
    greyHigh.gain.value = 0;
    
    // === RESONANT FILTERS (for tonal/drone sounds) ===
    // Three bandpass filters that can be tuned to create harmonic content
    resonantFilters = [];
    resonantGains = [];
    for (let i = 0; i < 3; i++) {
        const filter = audioCtx.createBiquadFilter();
        filter.type = "bandpass";
        filter.frequency.value = 200 * (i + 1); // 200, 400, 600 Hz default
        filter.Q.value = 1; // Low Q = wide band, High Q = resonant/tonal
        resonantFilters.push(filter);
        
        const gain = audioCtx.createGain();
        gain.gain.value = 0; // Off by default
        resonantGains.push(gain);
    }
    
    // === COMB FILTER (for metallic/hollow sounds) ===
    // Created using a delay line feeding back into itself
    combDelay = audioCtx.createDelay(0.1); // Max 100ms delay
    combDelay.delayTime.value = 0.005; // 5ms = metallic tone ~200Hz
    combFeedback = audioCtx.createGain();
    combFeedback.gain.value = 0; // 0 = off, 0.7-0.9 = strong comb effect
    combMix = audioCtx.createGain();
    combMix.gain.value = 0; // Dry/wet mix for comb
    
    // Comb filter feedback loop
    combDelay.connect(combFeedback);
    combFeedback.connect(combDelay);
    
    pulseGain = audioCtx.createGain();
    pulseGain.gain.value = 1;
    
    pulseOsc = audioCtx.createOscillator();
    pulseOsc.type = 'sine';
    pulseOsc.frequency.value = 0.2;
    pulseOsc.start();
    
    depthNode = audioCtx.createGain();
    depthNode.gain.value = 0;
    
    pulseOsc.connect(depthNode);
    depthNode.connect(pulseGain.gain);
    
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    analyser.smoothingTimeConstant = 0.8;
    
    gainNode = audioCtx.createGain();
    gainNode.gain.value = 0;
    
    // === AUDIO ROUTING ===
    // Main path: noise -> pulse -> grey EQ -> output
    // Resonant path: noise -> bandpass filters (parallel) -> mix back in
    // Comb path: noise -> comb filter -> mix back in
    
    // Create a dry path and wet mix node
    dryGain = audioCtx.createGain();
    dryGain.gain.value = 1;
    
    wetMix = audioCtx.createGain();
    wetMix.gain.value = 0;
    
    // Main routing
    noiseNode.connect(pulseGain);
    
    // Dry path (original signal)
    pulseGain.connect(dryGain);
    
    // Resonant filters (parallel)
    for (let i = 0; i < 3; i++) {
        pulseGain.connect(resonantFilters[i]);
        resonantFilters[i].connect(resonantGains[i]);
        resonantGains[i].connect(wetMix);
    }
    
    // Comb filter path
    pulseGain.connect(combDelay);
    combDelay.connect(combMix);
    combMix.connect(wetMix);
    
    // Mix dry and wet, then through grey EQ to output
    dryGain.connect(greyLow);
    wetMix.connect(greyLow);
    greyLow.connect(greyHigh);
    greyHigh.connect(analyser);
    analyser.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    
    applySettings(currentSettings, true);
}

// --- 12. Visualizer ---
function resizeCanvas() {
    const rect = canvas.parentElement.getBoundingClientRect();
    canvas.width = rect.width - 32;
    canvas.height = 80;
}

resizeCanvas();
window.addEventListener('resize', resizeCanvas);

function drawBars() {
    if (!analyser) return;
    
    const bufferLength = analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    analyser.getByteFrequencyData(dataArray);
    
    ctx.fillStyle = '#0a0a0f';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    const barWidth = (canvas.width / bufferLength) * 2;
    let x = 0;
    
    for (let i = 0; i < bufferLength; i++) {
        const barHeight = (dataArray[i] / 255) * canvas.height * 0.9;
        
        const gradient = ctx.createLinearGradient(0, canvas.height - barHeight, 0, canvas.height);
        gradient.addColorStop(0, '#00e5cc');
        gradient.addColorStop(1, '#7b61ff');
        
        ctx.fillStyle = gradient;
        ctx.fillRect(x, canvas.height - barHeight, barWidth - 1, barHeight);
        
        x += barWidth;
    }
}

function drawWave() {
    if (!analyser) return;
    
    const bufferLength = analyser.fftSize;
    const dataArray = new Uint8Array(bufferLength);
    analyser.getByteTimeDomainData(dataArray);
    
    ctx.fillStyle = '#0a0a0f';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    ctx.lineWidth = 2;
    ctx.strokeStyle = '#00e5cc';
    ctx.shadowBlur = 8;
    ctx.shadowColor = '#00e5cc';
    
    ctx.beginPath();
    const sliceWidth = canvas.width / bufferLength;
    let x = 0;
    
    for (let i = 0; i < bufferLength; i++) {
        const v = dataArray[i] / 128.0;
        const y = (v * canvas.height) / 2;
        
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
        x += sliceWidth;
    }
    
    ctx.stroke();
    ctx.shadowBlur = 0;
}

function visualizerLoop() {
    if (vizMode === 'bars') drawBars();
    else drawWave();
    animationId = requestAnimationFrame(visualizerLoop);
}

function startVisualizer() {
    if (!animationId) visualizerLoop();
}

function stopVisualizer() {
    if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
    }
    ctx.fillStyle = '#0a0a0f';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
}

vizBarsBtn.addEventListener('click', () => {
    vizMode = 'bars';
    vizBarsBtn.classList.add('active');
    vizWaveBtn.classList.remove('active');
});

vizWaveBtn.addEventListener('click', () => {
    vizMode = 'wave';
    vizWaveBtn.classList.add('active');
    vizBarsBtn.classList.remove('active');
});

// --- 13. Timer with Fade-Out ---
document.querySelectorAll('.timer-preset-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const mins = parseInt(btn.dataset.mins);
        startTimer(mins);
        
        document.querySelectorAll('.timer-preset-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    });
});

function startTimer(minutes) {
    if (timerInterval) clearInterval(timerInterval);
    
    timerEndTime = Date.now() + minutes * 60 * 1000;
    timerFadeStarted = false;
    timerCancel.style.display = 'inline-block';
    timerDisplay.classList.add('active');
    timerDisplay.classList.remove('fading');
    
    updateTimerDisplay();
    timerInterval = setInterval(updateTimerDisplay, 1000);
}

function updateTimerDisplay() {
    const remaining = timerEndTime - Date.now();
    const fadeOutDuration = (currentSettings.fadeOut || 2) * 1000;
    
    // Start fade early
    if (remaining <= fadeOutDuration && !timerFadeStarted && isPlaying) {
        timerFadeStarted = true;
        timerDisplay.classList.add('fading');
        timerDisplay.classList.remove('active');
        powerOff();
    }
    
    if (remaining <= 0) {
        cancelTimer();
        return;
    }
    
    const mins = Math.floor(remaining / 60000);
    const secs = Math.floor((remaining % 60000) / 1000);
    timerDisplay.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

function cancelTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
    timerEndTime = null;
    timerFadeStarted = false;
    timerDisplay.textContent = '--:--';
    timerDisplay.classList.remove('active', 'fading');
    timerCancel.style.display = 'none';
    document.querySelectorAll('.timer-preset-btn').forEach(b => b.classList.remove('active'));
}

timerCancel.addEventListener('click', cancelTimer);

// --- 14. URL State ---
function updateURL() {
    const params = new URLSearchParams();
    params.set('c', currentSettings.alpha);
    params.set('p', currentSettings.pulse);
    params.set('ps', currentSettings.pulseShape);
    params.set('g', currentSettings.grey ? '1' : '0');
    params.set('d', currentSettings.dist);
    params.set('b', currentSettings.binaural ? '1' : '0');
    params.set('bf', currentSettings.binauralFreq);
    params.set('fi', currentSettings.fadeIn);
    params.set('fo', currentSettings.fadeOut);
    params.set('v', sliderVol.value);
    
    const newUrl = `${window.location.pathname}?${params.toString()}`;
    history.replaceState(null, '', newUrl);
}

function loadFromURL() {
    const params = new URLSearchParams(window.location.search);
    
    if (params.has('c')) { currentSettings.alpha = parseFloat(params.get('c')); sliderColor.value = currentSettings.alpha; }
    if (params.has('p')) { currentSettings.pulse = parseFloat(params.get('p')); sliderPulse.value = currentSettings.pulse; }
    if (params.has('ps')) { currentSettings.pulseShape = params.get('ps'); selPulseShape.value = currentSettings.pulseShape; }
    if (params.has('g')) { currentSettings.grey = params.get('g') === '1'; checkGrey.checked = currentSettings.grey; }
    if (params.has('d')) { currentSettings.dist = parseInt(params.get('d')); selDist.value = currentSettings.dist; }
    if (params.has('b')) { currentSettings.binaural = params.get('b') === '1'; checkBinaural.checked = currentSettings.binaural; binauralFreqGroup.style.display = currentSettings.binaural ? 'block' : 'none'; }
    if (params.has('bf')) { currentSettings.binauralFreq = parseFloat(params.get('bf')); sliderBinaural.value = currentSettings.binauralFreq; }
    if (params.has('fi')) { currentSettings.fadeIn = parseInt(params.get('fi')); sliderFadeIn.value = currentSettings.fadeIn; }
    if (params.has('fo')) { currentSettings.fadeOut = parseInt(params.get('fo')); sliderFadeOut.value = currentSettings.fadeOut; }
    if (params.has('v')) { sliderVol.value = parseFloat(params.get('v')); }
    
    updateLabels();
}

// --- 15. Keyboard Shortcuts ---
document.addEventListener('keydown', (e) => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    
    switch (e.code) {
        case 'Space':
            e.preventDefault();
            powerBtn.click();
            break;
        case 'ArrowUp':
            e.preventDefault();
            sliderVol.value = Math.min(1, parseFloat(sliderVol.value) + 0.05);
            sliderVol.dispatchEvent(new Event('input'));
            break;
        case 'ArrowDown':
            e.preventDefault();
            sliderVol.value = Math.max(0, parseFloat(sliderVol.value) - 0.05);
            sliderVol.dispatchEvent(new Event('input'));
            break;
        case 'Digit1': case 'Digit2': case 'Digit3': case 'Digit4': case 'Digit5':
        case 'Digit6': case 'Digit7': case 'Digit8': case 'Digit9':
            const idx = parseInt(e.code.replace('Digit', '')) - 1;
            const btns = presetContainer.querySelectorAll('.preset-btn:not(.custom)');
            if (btns[idx]) btns[idx].click();
            break;
    }
});

// --- 16. Initialize ---
renderPresets();
loadFromURL();
updateLabels();

ctx.fillStyle = '#0a0a0f';
ctx.fillRect(0, 0, canvas.width, canvas.height);
</script>
</body>
</html>
